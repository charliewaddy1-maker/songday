const saveBtn = document.getElementById("saveSongs");
const status = document.getElementById("status");
const form = document.getElementById("songForm");

if (saveBtn && form) {
  saveBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    const gameId = new URLSearchParams(window.location.search).get("game");
    const player = new URLSearchParams(window.location.search).get("player");

    if (!gameId || !player) {
      alert("Missing game or player information in URL.");
      return;
    }

    // Gather songs from input
    const songs = [];
    for (let i = 1; i <= 10; i++) {
      const title = document.getElementById(`title${i}`)?.value.trim();
      const artist = document.getElementById(`artist${i}`)?.value.trim();
      const link = document.getElementById(`link${i}`)?.value.trim();
      if (title && artist) {
        songs.push({ title, artist, link });
      }
    }

    if (songs.length === 0) {
      alert("Enter at least one song (title and artist).");
      return;
    }

    try {
      const res = await fetch("https://songday-api.charlie-waddy1.workers.dev/submit-song", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ gameId, player, songs })
      });

      const data = await res.json();

      if (data.ok) {
        status.style.color = "green";
        status.textContent = "Thank you! Songs submitted â€” waiting on full playlist to be created by the host.";
        saveBtn.disabled = true;
      } else {
        alert("Error submitting songs: " + data.message);
      }

    } catch (err) {
      console.error(err);
      alert("Network error: could not submit songs.");
    }
  });
}
